# Historonics Agent Integration Guide

## Overview

The Historonics Agent is a read-only historical research agent that generates structured hypotheses about what to study next, without modifying simulation logic, scoring, or parameters.

## Key Invariants

✅ **Advisory Only**: All outputs are non-binding, untested hypotheses  
✅ **Read-Only**: Cannot modify simulation results, scoring logic, or parameters  
✅ **No Executable Logic**: Outputs are text + metadata, never code  
✅ **LLM Safety**: Explicit prompt constraints prevent optimization/prediction  

## Integration Points

### 1. Research Loop Integration

The Historonics Agent is integrated into `daemon/research_loop.py`:

- **Called After**: Memory update (Step 4)
- **Called Before**: Proposal generation (Step 6)
- **Purpose**: Inform proposal agent with historical context

```python
# Step 5: Generate historical hypotheses (optional, advisory only)
if self.historonics_agent:
    historonics_output = self.historonics_agent.generate_hypotheses(
        report_summary=report_summary,
        insights=insights_summary,
        regime_coverage=regime_coverage,
        scenario_metadata=scenario_metadata,
        iteration_id=iteration_id
    )
```

### 2. Report Integration (Optional)

Hypotheses can be included in research reports via the `appendix_historonics_hypotheses` field:

```python
report = ResearchReport(
    # ... other fields ...
    appendix_historonics_hypotheses=[hyp.model_dump() for hyp in historonics_output.hypotheses]
)
```

## Usage

### Generate Hypotheses from Research Loop

The Historonics Agent is automatically called during research loop iterations if:
1. LLM engine is available (OPENROUTER_API_KEY set)
2. Historonics Agent is initialized

### Generate Hypotheses Manually

```python
from agents.research.historonics_agent import get_historonics_agent

agent = get_historonics_agent()

output = agent.generate_hypotheses(
    report_summary="Research findings summary...",
    insights=[...],  # List of insight dicts
    regime_coverage={"regime_id": count, ...},
    scenario_metadata=[{"scenario_id": "...", "regime_id": "..."}],
    report_id="FRR-2025-01-01",
    iteration_id="iter_123"
)

for hypothesis in output.hypotheses:
    print(f"{hypothesis.hypothesis_id}: {hypothesis.summary}")
```

## Output Schema

Each hypothesis includes:

- `hypothesis_id`: Stable hash identifier
- `hypothesis_type`: historical_analogy | regime_transition | failure_precursor | parameter_risk
- `summary`: Concise statement
- `historical_analogs`: List of relevant historical periods
- `linked_insights`: Insight IDs that inform this hypothesis
- `regimes_implicated`: Regime IDs relevant to hypothesis
- `uncertainty_notes`: Explicit limitations
- `recommended_validation`: Non-binding test suggestions

## Safety Checks

The agent performs validation to reject hypotheses that:
- Contain numeric prescriptions (thresholds, parameter values)
- Suggest executable code or logic changes
- Claim certainty or authority
- Lack explicit uncertainty notes

## Report Rendering

When included in reports, hypotheses are rendered in a dedicated section:

```
## Historical Context & Hypothesis Generation (Advisory)

*The following hypotheses are generated by the Historonics Agent.
They are non-binding, unvalidated, and require deterministic testing.*

### hypothesis_id (Type)

Status: UNTESTED | Source: Historonics Agent | Evidence Level: Narrative only

Summary: ...

Historical Analogs:
- Period: Description (confidence: X.XX)

Linked Insights: insight_id_1, insight_id_2

Regimes Implicated: regime_id_1, regime_id_2

Uncertainty Notes: ...

Recommended Validation: ...
```

## Proposal Agent Integration

The Proposal Agent retains full control:
- Information gain scoring
- Top-3 cap enforcement
- Evidence gating
- Ranking logic

Historonics hypotheses are treated as **inputs** (context), not decisions.

## Error Handling

The Historonics Agent fails gracefully:
- If LLM unavailable: Returns empty output, research loop continues
- If validation fails: Rejects invalid hypotheses, keeps valid ones
- If API error: Logs warning, returns empty output

## Testing

```bash
# Test Historonics Agent import
python -c "from agents.research.historonics_agent import get_historonics_agent; agent = get_historonics_agent(); print('OK')"

# Test with research loop (requires API key)
python -m daemon.research_loop
```

## Configuration

Set in `.env`:
```bash
OPENROUTER_API_KEY=your_key_here
DEEPSEEK_MODEL=deepseek/deepseek-r1  # or deepseek/deepseek-chat
```

If API key is not set, the agent initializes but returns empty outputs (non-critical).

