{% extends "base.html" %}

{% block title %}Triggers Dashboard - FuggerBot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h3 class="mb-0"><i class="bi bi-bell"></i> Price Triggers</h3>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Error:</strong> {{ error }}
                </div>
                {% endif %}

                {% if success_message %}
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle"></i> {{ success_message }}
                </div>
                {% endif %}

                <h5 class="mb-3">Existing Triggers</h5>
                
                {% if triggers %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Condition</th>
                                <th>Value</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th>Last Fired</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trigger in triggers %}
                                {% with index=loop.index0 %}
                                    {% include "partials/trigger_row.html" %}
                                {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No triggers yet. Create one below to get started.
                </div>
                {% endif %}

                <hr>

                <h5 class="mb-3">Create New Trigger</h5>
                <form method="POST" action="/triggers">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="symbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="symbol" name="symbol" 
                                   placeholder="AAPL" value="{{ symbol or '' }}" required 
                                   pattern="[A-Z]{1,10}" title="1-10 uppercase letters">
                            <div class="form-text">Trading symbol (e.g., AAPL, MSFT, INTC)</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="condition" class="form-label">Condition</label>
                            <select class="form-select" id="condition" name="condition" required>
                                <option value="<" {% if condition == "<" %}selected{% endif %}>Price Below</option>
                                <option value=">" {% if condition == ">" %}selected{% endif %}>Price Above</option>
                                <option value="drop_pct" {% if condition == "drop_pct" %}selected{% endif %}>Drop Percentage</option>
                                <option value="rise_pct" {% if condition == "rise_pct" %}selected{% endif %}>Rise Percentage</option>
                            </select>
                            <div class="form-text">Trigger condition type</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="value" class="form-label">Value / Threshold</label>
                            <input type="number" class="form-control" id="value" name="value" 
                                   value="{{ value or '' }}" min="0" step="0.01" required>
                            <div class="form-text">Price threshold or percentage value</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="action" class="form-label">Action</label>
                            <select class="form-select" id="action" name="action" required>
                                <option value="notify" {% if action == "notify" %}selected{% endif %}>Notify (SMS Alert)</option>
                                <option value="buy" {% if action == "buy" %}selected{% endif %}>Buy</option>
                                <option value="sell" {% if action == "sell" %}selected{% endif %}>Sell</option>
                                <option value="layer_in" {% if action == "layer_in" %}selected{% endif %}>Layer In (Incremental Buy)</option>
                            </select>
                            <div class="form-text">Action to take when trigger fires</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enabled" name="enabled" value="on"
                                   {% if enabled is not defined or enabled %}checked{% endif %}>
                            <label class="form-check-label" for="enabled">
                                Enable trigger immediately
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="bi bi-plus-circle"></i> Create Trigger
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> How Triggers Work</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li><strong>Create a trigger</strong> by specifying a symbol, condition, and action</li>
                    <li><strong>Triggers monitor prices</strong> and fire when the condition is met</li>
                    <li><strong>Actions available:</strong>
                        <ul>
                            <li><strong>Notify:</strong> Sends SMS alert when trigger fires</li>
                            <li><strong>Buy:</strong> Requests trade approval to buy shares</li>
                            <li><strong>Sell:</strong> Requests trade approval to sell shares</li>
                            <li><strong>Layer In:</strong> Incrementally buys shares as price drops</li>
                        </ul>
                    </li>
                    <li><strong>Enable/Disable:</strong> Toggle triggers on or off without deleting them</li>
                    <li><strong>Monitor:</strong> Run <code>python run_monitor.py</code> for continuous background monitoring</li>
                </ol>
                <p class="text-muted mb-0">
                    <strong>Note:</strong> Triggers are checked when this page loads. For continuous monitoring, 
                    use the background monitor service.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

